{% extends "base.html.j2" %}
{% block title %}Sentinel State Dashboard{% endblock %}
{% block head_extra %}
<script src="{{ app.url_for('static', filename='htmx.js') }}"></script>
<script src="{{ app.url_for('static', filename='htmx-ext-sse.js') }}"></script>
{% endblock %}
{% block body %}
{% set table_query = "?page=" ~ page ~ "&page_size=" ~ page_size ~ "&include_closed=" ~ (1 if include_closed else 0) %}
{% if repo_filter %}
{% set table_query = table_query ~ "&repo=" ~ repo_filter %}
{% endif %}
<main id="state-dashboard" class="state-dashboard" hx-ext="sse" sse-connect="/state/stream">
    {% if not projection_publish_enabled %}
    <section class="mode-indicator mode-indicator-dry-run">
        Dry run mode active: evaluation runs, GitHub publish is disabled.
    </section>
    {% endif %}

    <header class="state-header">
        <h1>Sentinel State Dashboard</h1>
        <p>Live view from webhook projections and sentinel evaluation state.</p>
    </header>

    <form method="get" action="/state" class="state-filters">
        <label for="repo">Repository</label>
        <input id="repo" name="repo" type="text" placeholder="owner/name" value="{{ repo_filter }}">

        <label for="page_size">Page Size</label>
        <select id="page_size" name="page_size">
            {% for option in [25, 50, 100, 200] %}
            <option value="{{ option }}" {% if page_size == option %}selected{% endif %}>{{ option }}</option>
            {% endfor %}
        </select>

        <input type="hidden" name="include_closed" value="0">
        <label for="include_closed">
            <input id="include_closed" name="include_closed" type="checkbox" value="1" {% if include_closed %}checked{% endif %}>
            Include closed PRs
        </label>

        <input type="hidden" name="page" value="1">
        <button type="submit">Apply</button>
    </form>

    <div
        id="state-table-refresh"
        hx-get="/state/table{{ table_query }}"
        hx-trigger="sse:state_update throttle:500ms, refresh"
        hx-target="#state-table-container"
        hx-swap="innerHTML"
    ></div>

    <section id="state-table-container">
        {% include "state_table.html.j2" %}
    </section>
</main>
{% endblock %}
{% block scripts %}
<script>
(() => {
    const tableContainer = document.getElementById("state-table-container");
    const refreshTrigger = document.getElementById("state-table-refresh");
    let relativeTimesTimer = null;
    let previousSignatures = new Map();

    const captureRowSignatures = (root) => {
        const signatures = new Map();
        if (!root) {
            return signatures;
        }
        root.querySelectorAll("tr[data-row-key]").forEach((row) => {
            const key = row.getAttribute("data-row-key");
            if (!key) {
                return;
            }
            signatures.set(key, row.getAttribute("data-row-signature") || "");
        });
        return signatures;
    };

    const formatLocalTimes = (root) => {
        if (!root) {
            return;
        }
        const pad2 = (value) => String(value).padStart(2, "0");
        const formatLocalDateTime = (dt) =>
            `${dt.getFullYear()}-${pad2(dt.getMonth() + 1)}-${pad2(dt.getDate())} ` +
            `${pad2(dt.getHours())}:${pad2(dt.getMinutes())}:${pad2(dt.getSeconds())}`;
        const formatRelativeTime = (dt) => {
            const nowMs = Date.now();
            const diffSeconds = Math.round((dt.getTime() - nowMs) / 1000);
            const absSeconds = Math.abs(diffSeconds);

            if (absSeconds < 5) {
                return { text: "just now", unit: "s" };
            }

            const units = [
                { seconds: 31536000, label: "y" },
                { seconds: 2592000, label: "mo" },
                { seconds: 604800, label: "w" },
                { seconds: 86400, label: "d" },
                { seconds: 3600, label: "h" },
                { seconds: 60, label: "m" },
                { seconds: 1, label: "s" },
            ];

            let value = absSeconds;
            let unit = "s";
            for (const candidate of units) {
                if (absSeconds >= candidate.seconds) {
                    value = Math.floor(absSeconds / candidate.seconds);
                    unit = candidate.label;
                    break;
                }
            }

            if (diffSeconds < 0) {
                return { text: `${value}${unit} ago`, unit };
            }
            return { text: `in ${value}${unit}`, unit };
        };
        root.querySelectorAll("[data-utc]").forEach((el) => {
            const raw = el.getAttribute("data-utc");
            if (!raw) {
                return;
            }
            const dt = new Date(raw);
            if (Number.isNaN(dt.getTime())) {
                return;
            }
            const relative = formatRelativeTime(dt);
            el.textContent = relative.text;
            el.setAttribute("data-relative-unit", relative.unit);
            el.title = `${formatLocalDateTime(dt)} local (${raw})`;
        });
    };

    const scheduleRelativeTimesRefresh = () => {
        if (relativeTimesTimer !== null) {
            window.clearTimeout(relativeTimesTimer);
            relativeTimesTimer = null;
        }
        const hasSecondPrecision = document.querySelector("[data-relative-unit='s']") !== null;
        const nextDelayMs = hasSecondPrecision ? 1000 : 30000;
        relativeTimesTimer = window.setTimeout(() => {
            formatLocalTimes(document);
            scheduleRelativeTimesRefresh();
        }, nextDelayMs);
    };

    document.body.addEventListener("htmx:beforeRequest", (event) => {
        const requestElement = event.detail.elt;
        if (!(requestElement instanceof Element) || requestElement.id !== "state-table-refresh") {
            return;
        }
        previousSignatures = captureRowSignatures(tableContainer);
    });

    document.body.addEventListener("htmx:afterSwap", (event) => {
        const target = event.detail.target;
        if (!(target instanceof Element) || target.id !== "state-table-container") {
            return;
        }
        target.querySelectorAll("tr[data-row-key]").forEach((row) => {
            const key = row.getAttribute("data-row-key");
            if (!key) {
                return;
            }
            const previousSignature = previousSignatures.get(key);
            const nextSignature = row.getAttribute("data-row-signature") || "";
            if (previousSignature !== undefined && previousSignature !== nextSignature) {
                row.classList.add("row-flash-once");
            }
        });
        formatLocalTimes(tableContainer);
        scheduleRelativeTimesRefresh();
    });

    window.addEventListener("pageshow", (event) => {
        if (event.persisted && refreshTrigger) {
            htmx.trigger(refreshTrigger, "refresh");
        }
    });

    window.addEventListener("pagehide", () => {
        if (relativeTimesTimer !== null) {
            window.clearTimeout(relativeTimesTimer);
            relativeTimesTimer = null;
        }
    });

    document.addEventListener("visibilitychange", () => {
        if (!document.hidden && refreshTrigger) {
            htmx.trigger(refreshTrigger, "refresh");
        }
    });

    formatLocalTimes(document);
    scheduleRelativeTimesRefresh();
})();
</script>
{% endblock %}
