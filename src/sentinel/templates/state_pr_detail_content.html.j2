{% if not app.config.PROJECTION_PUBLISH_ENABLED %}
<section class="mode-indicator mode-indicator-dry-run">
    Dry run mode active: evaluation runs, GitHub publish is disabled.
</section>
{% endif %}

<header class="state-header">
    <h1>PR #{{ row.pr_number }}{% if row.pr_title %}: {{ row.pr_title }}{% endif %}</h1>
    <p>{{ row.repo_full_name }}</p>
</header>

<nav class="state-pagination">
    <a href="/state">Back to Dashboard</a>
    {% if row.pr_url %}<a href="{{ row.pr_url }}" target="_blank" rel="noreferrer">GitHub PR</a>{% endif %}
    {% if row.commit_url %}<a href="{{ row.commit_url }}" target="_blank" rel="noreferrer">Head Commit</a>{% endif %}
    {% if row.check_run_url %}<a href="{{ row.check_run_url }}" target="_blank" rel="noreferrer">Check Run</a>{% endif %}
</nav>

<section class="pr-summary-grid">
    <div>
        <strong>PR State:</strong>
        <span class="chip chip-pr {{ row.pr_state_class }}">{{ row.pr_state_display }}</span>
        {% if row.pr_is_draft %}
        <span class="chip chip-pr {{ row.pr_draft_class }}">draft</span>
        {% endif %}
    </div>
    <div>
        <strong>Sentinel:</strong>
        <span class="chip chip-status {{ row.sentinel_status_class }}">{{ row.sentinel_status or "not_evaluated" }}</span>
        {% if row.sentinel_conclusion %}
        <span class="chip chip-conclusion {{ row.sentinel_conclusion_class }}">{{ row.sentinel_conclusion }}</span>
        {% endif %}
    </div>
    <div>
        <strong>Head SHA:</strong>
        {% if row.head_sha %}
        <span title="{{ row.head_sha }}"><code>{{ row.short_sha }}</code></span>
        {% else %}
        -
        {% endif %}
    </div>
    <div>
        <strong>Last Eval:</strong>
        {% if row.last_eval_at %}
        <span data-utc="{{ row.last_eval_at }}">{{ row.last_eval_at }}</span>
        {% else %}
        -
        {% endif %}
    </div>
    <div>
        <strong>Last Publish:</strong> {{ row.publish_result_display }} at
        {% if row.last_publish_at %}
        <span data-utc="{{ row.last_publish_at }}">{{ row.last_publish_at }}</span>
        {% else %}
        -
        {% endif %}
    </div>
</section>

<section class="detail-section">
    <h2>Check Summary</h2>
    <p class="muted">
        <strong>Combined status:</strong>
        {% if row.sentinel_status %}
        {{ row.sentinel_status }}{% if row.sentinel_conclusion %}/{{ row.sentinel_conclusion }}{% endif %}
        {% else %}
        not_evaluated
        {% endif %}
    </p>
    {% if row.output_checks and row.output_checks|length > 0 %}
    <table class="state-table check-summary-table">
        <thead>
        <tr>
            <th>Check</th>
            <th>Status</th>
            <th>Required</th>
        </tr>
        </thead>
        <tbody>
        {% for check in row.output_checks %}
        <tr>
            <td>
                {% if check.html_url %}
                <a href="{{ check.html_url }}" target="_blank" rel="noreferrer">{{ check.name }}</a>
                {% else %}
                {{ check.name }}
                {% endif %}
            </td>
            <td>
                <span class="check-status-pill {{ check.status_class }}">
                    {% if check.is_running %}
                    <span class="check-spinner" aria-hidden="true"></span>
                    {% else %}
                    {% if check.status_symbol %}
                    <span class="check-status-symbol">{{ check.status_symbol }}</span>
                    {% endif %}
                    {% endif %}
                    <span>{{ check.status }}</span>
                </span>
            </td>
            <td>{{ "yes" if check.required else "no" }}</td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="muted">No structured check summary available yet.</p>
    {% endif %}
</section>

<section class="detail-section">
    <details class="detail-collapsible">
        <summary>Rendered Raw Output (sent to GitHub)</summary>
        <div class="detail-collapsible-body">
            <h3>{{ row.output_title or "No output title" }}</h3>
            <div class="rendered-markdown">{{ row.rendered_output_summary | safe }}</div>
            <div class="rendered-markdown">{{ row.rendered_output_text | safe }}</div>
        </div>
    </details>
</section>

<section class="detail-section">
    <h2>Related Events (Most Recent First)</h2>
    {% if events|length == 0 %}
    <p class="muted">No matching events found.</p>
    {% else %}
    <table class="state-table">
        <thead>
        <tr>
            <th>Received</th>
            <th>Event</th>
            <th>Action</th>
            <th>Detail</th>
            <th>Delivery</th>
        </tr>
        </thead>
        <tbody>
        {% for event in events %}
        <tr{% if event.is_activity %} class="event-row-sentinel"{% endif %}>
            <td class="muted"><span data-utc="{{ event.received_at }}">{{ event.received_at }}</span></td>
            <td>{{ event.event }}</td>
            <td>{{ event.action or "-" }}</td>
            <td>{{ event.detail or "-" }}</td>
            <td>
                {% if event.details_url %}
                <a href="{{ event.details_url }}"><code>{{ event.delivery_id }}</code></a>
                {% else %}
                <code>{{ event.delivery_id }}</code>
                {% endif %}
            </td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
    {% endif %}
</section>
